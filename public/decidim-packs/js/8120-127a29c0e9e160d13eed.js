"use strict";(self.webpackChunkdecidim_development_app=self.webpackChunkdecidim_development_app||[]).push([[8120],{48535:function(t,e,n){n.d(e,{g:function(){return b}});var s=n(50867),i=n(57587),r=n(84087),o=n(68373),a=n.n(o),l=n(5830),c=n.n(l),u=n(49262),d=n.n(u),p=n(11722),h=n.n(p),y=n(96607),g=n.n(y);class b{constructor({apiEndpointUrl:t,headers:e}){const n=new s.u({uri:t,headers:e});this.apolloClient=new i.f({link:n,cache:new r.h})}async getLogEntry({electionUniqueId:t,contentHash:e}){return(await this.apolloClient.query({query:h(),variables:{electionUniqueId:t,contentHash:e}})).data.logEntry}async getElectionLogEntries({electionUniqueId:t,after:e,types:n}){return(await this.apolloClient.query({query:a(),variables:{electionUniqueId:t,after:e,types:n},fetchPolicy:"no-cache"})).data.election.logEntries}async processKeyCeremonyStep({messageId:t,signedData:e}){const n=await this.apolloClient.mutate({mutation:c(),variables:{messageId:t,signedData:e}});if(n.data.processKeyCeremonyStep.error)throw new Error(n.data.processKeyCeremonyStep.error);return n.data.processKeyCeremonyStep.pendingMessage}async getPendingMessageByMessageId({messageId:t}){return(await this.apolloClient.query({query:g(),variables:{messageId:t}})).data.pendingMessage}async processTallyStep({messageId:t,signedData:e}){const n=await this.apolloClient.mutate({mutation:d(),variables:{messageId:t,signedData:e}});if(n.data.processTallyStep.error)throw new Error(n.data.processTallyStep.error);return n.data.processTallyStep.pendingMessage}}},44101:function(t,e,n){n.d(e,{Gu:function(){return i},HP:function(){return r},Ly:function(){return s},wC:function(){return a}});const s="a",i="b",r="t",o=[s,i,"v",r];class a{static parse(t){const[e,n]=t.split("+"),[s,i,r,a]=e.split(".",4),[l,c]=n.split(".",2),u=a?`.${a}`:"";if(!o.includes(l))throw new Error("Invalid message identifier format");return{electionId:`${s}.${i}`,type:r,subtype:a,typeSubtype:`${r}${u}`,author:{type:l,id:c}}}static format(t,e,n,s){return`${t}.${e}+${n}.${s}`}}},42670:function(t,e,n){n.d(e,{t:function(){return o}});var s=n(21217),i=n(44101),r=n(39669);class o{constructor({authorityPublicKeyJSON:t}){this.authorityPublicKeyJSON=t,this.authorityPublicKey=s.JWK.asKey(t,"json"),this.keys=null}async parse({messageId:t,signedData:e}){const n=i.wC.parse(t),r=await(this.keys?this.keys[n.author.type][n.author.id]:this.authorityPublicKey);if(!e)return{messageIdentifier:n,decodedData:null};const o=await s.JWS.createVerify(r).verify(e,{algorithms:["RS256"]}),a=JSON.parse(new TextDecoder("utf-8").decode(o.payload));return this.keys||(this.keys=await this.parseCreateElection(a)),{messageIdentifier:n,decodedData:a}}async parseCreateElection({authority:t,bulletin_board:e,trustees:n}){if(!(0,r.h)(t.public_key,this.authorityPublicKeyJSON))throw new Error("The authority public key doesn't match the election's authority public key.");const s={[i.Ly]:{[t.slug]:this.authorityPublicKey},[i.Gu]:{},[i.HP]:{}},o=[];o.push(this.loadKey(e).then((t=>{s[i.Gu][e.slug]=t})));for(const r of n)o.push(this.loadKey(r).then((t=>{s[i.HP][r.slug]=t})));return await Promise.all(o),s}loadKey(t){return s.JWK.asKey(t.public_key,"json")}}},17163:function(t,e,n){n.d(e,{b:function(){return i}});var s=n(44101);class i{constructor({uniqueId:t,bulletinBoardClient:e,typesFilter:n,options:s}){this.uniqueId=t,this.bulletinBoardClient=e,this.logEntries=[],this.typesFilter=n,this.subscriptionId=null,this.options=s||{waitUntilNextCheck:2e3}}async subscribeToLogEntriesChanges(){this.unsubscribeToLogEntriesChanges(),await this.getLogEntries(),this.subscriptionId=setInterval((()=>{this.getLogEntries()}),this.options.waitUntilNextCheck)}unsubscribeToLogEntriesChanges(){null!==this.subscriptionId&&(clearInterval(this.subscriptionId),this.subscriptionId=null)}getLastMessageFromTrustee(t){for(let e=this.logEntries.length-1;e>=0;e--){const n=this.logEntries[e],i=s.wC.parse(n.messageId);if(i.author.type===s.HP&&i.author.id===t)return n}return null}getLogEntries(){const t=this.logEntries[this.logEntries.length-1],e=t&&t.id||null;return new Promise((t=>{this.bulletinBoardClient.getElectionLogEntries({electionUniqueId:this.uniqueId,after:e,types:this.typesFilter}).then((e=>{e.length&&(this.logEntries=[...this.logEntries,...e]),t()}))}))}}},78169:function(t,e,n){n.d(e,{_3:function(){return s._}});n(6388),n(17163),n(5239),n(29591),n(42670),n(44101),n(16855),n(10050);var s=n(73646)},16855:function(t,e,n){n(69912)},10050:function(t,e,n){n(69912)},69912:function(t,e,n){n(5239),n(6388),n(17163)},5239:function(t,e,n){n(42670),n(44101)},73646:function(t,e,n){n.d(e,{_:function(){return o}});var s=n(6388),i=n(17163),r=n(29591);class o{constructor({bulletinBoardClientParams:t,authorityPublicKeyJSON:e,electionUniqueId:n,voterUniqueId:o,voterWrapperAdapter:a}){this.bulletinBoardClient=new s.K(t);const l=new i.b({uniqueId:n,bulletinBoardClient:this.bulletinBoardClient});this.voter=new r.a({bulletinBoardClient:this.bulletinBoardClient,authorityPublicKeyJSON:e,election:l,uniqueId:o,wrapperAdapter:a})}async bindEvents({onBindEncryptButton:t,onStart:e,onVoteEncryption:n,castOrAuditBallot:s,onBindAuditBallotButton:i,onBindCastBallotButton:r,onAuditBallot:o,onCastBallot:a,onAuditComplete:l,onCastComplete:c,onInvalid:u}){const d=this.voter.setup();t((async()=>{e(),await d,n(((t,e)=>{this.voter.encrypt(t,e).then((t=>{s(t),i((()=>{o(t,`${this.voter.uniqueId}-election-${this.voter.election.uniqueId}.txt`),l()})),r((async()=>{try{const e=await a(t);c(e)}catch{u()}}))}))}),(()=>{u()}))}))}}},29591:function(t,e,n){n.d(e,{a:function(){return i}});var s=n(42670);class i{constructor({bulletinBoardClient:t,authorityPublicKeyJSON:e,election:n,uniqueId:i,wrapperAdapter:r}){this.uniqueId=i,this.election=n,this.bulletinBoardClient=t,this.wrapperAdapter=r,this.parser=new s.t({authorityPublicKeyJSON:e})}async setup(){return await this.wrapperAdapter.setup(),this.bulletinBoardClient.getElectionLogEntries({electionUniqueId:this.election.uniqueId,types:["create_election","end_key_ceremony"]}).then((async t=>{for(const e of t){const{messageIdentifier:t,decodedData:n}=await this.parser.parse(e);await this.wrapperAdapter.processMessage(t.typeSubtype,n)}}))}async encrypt(t,e){const{encryptedData:n,auditableData:s}=await this.wrapperAdapter.encrypt(t,e);return{encryptedData:n,encryptedDataHash:await this.hash(n),auditableData:s,plainVote:t,electionUniqueId:this.election.uniqueId}}async hash(t){return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(t)).then((t=>Array.from(new Uint8Array(t)).map((t=>t.toString(16).padStart(2,"0"))).join("")))}verifyVote(t){const{uniqueId:e}=this.election;return this.bulletinBoardClient.getLogEntry({electionUniqueId:e,contentHash:t})}}},54486:function(t,e,n){n.d(e,{I:function(){return i}});class s{constructor({voterId:t,waitTime:e}){this.voterId=t,this.jointElectionKey=null,this.contests={},this.waitTime=e??500}processMessage(t,e){switch(t){case"create_election":this.contests=e.description.contests;break;case"end_key_ceremony":{const t=JSON.parse(e.content);this.jointElectionKey=t.joint_election_key;break}}}async encrypt(t,e){return new Promise((t=>setTimeout(t,500))).then((()=>{if(!this.jointElectionKey)return void console.warn("Invalid election status.");const e=this.createAuditableBallot(t);return{auditableData:e,encryptedData:JSON.stringify(this.createEncryptedData(JSON.parse(JSON.stringify(e))))}}))}createAuditableBallot(t){return{ballot_style:"ballot-style",contests:this.contests.map((({object_id:e,ballot_selections:n})=>({object_id:e,ballot_selections:n.map((n=>{const s=Math.random(),i=t[e]&&t[e].includes(n.object_id)?1:0;return{object_id:n.object_id,ciphertext:i+Math.floor(500*s+1)*this.jointElectionKey,random:s,plaintext:i}}))})))}}createEncryptedData(t){return this.removeAuditInformation(t)}removeAuditInformation(t){return t.contests.map((t=>t.ballot_selections.map((t=>(delete t.random,delete t.plaintext,t))))),t}}class i{constructor({voterId:t,waitTime:e}){this.voterId=t,this.wrapper=new s({voterId:t,waitTime:e})}setup(){}processMessage(t,e){return this.wrapper.processMessage(t,e)}encrypt(t,e){return this.wrapper.encrypt(t,e)}}},10179:function(t,e,n){n.d(e,{I:function(){return i}});class s{processPythonCodeOnWorker(t,e){return new Promise(((n,s)=>{this.worker.onmessage=t=>{n(t.data.results)},this.worker.onerror=t=>{console.error(t),s(t)},this.worker.postMessage({python:t,...e})}))}}class i extends s{constructor({voterId:t,workerUrl:e}){super(),this.voterId=t,this.worker=new Worker(e)}setup(){return this.processPythonCodeOnWorker("\n        from js import voter_id\n        from bulletin_board.electionguard.voter import Voter\n        voter = Voter(voter_id)\n      ",{voter_id:this.voterId})}async processMessage(t,e){const n=await this.processPythonCodeOnWorker("\n      import json\n      from js import message_type, decoded_data\n      voter.process_message(message_type, json.loads(decoded_data))\n    ",{message_type:t,decoded_data:JSON.stringify(e)});if(n&&n[0]){const{message_type:t,content:e}=n[0];return{messageType:t,content:e}}}async encrypt(t,e){const[n,s]=await this.processPythonCodeOnWorker("\n      from js import plain_vote, ballot_style\n      voter.encrypt(plain_vote, ballot_style)\n    ",{plain_vote:t,ballot_style:e});return{auditableData:n,encryptedData:s}}}}}]);
//# sourceMappingURL=8120-127a29c0e9e160d13eed.js.map